}
len_border <- sapply(data.CatL[-nrow(data.CatL),1], extract_last_number)
} else {
len_border <- len_border
}
if (is.null(len_mid)) {
contains_special_char <- function(s) {
return(grepl("<|>", s))
}
range_to_bin <- function(range_str) {
parts <- strsplit(range_str, "-")[[1]]
first_number <- as.numeric(parts[1])
last_number <- as.numeric(parts[2])
bin <- (last_number - first_number) / 2
return(bin)
}
bin <- range_to_bin(data.CatL[,1][2])
range_to_median <- function(range_str, isFirst = FALSE, isLast = FALSE, prev_range_str = "", next_range_str = "") {
if (contains_special_char(range_str)) {
parts <- strsplit(range_str, "-")[[1]]
single_number <- as.numeric(gsub("[^0-9]", "", parts[1]))
if (isFirst) {
next_parts <- strsplit(next_range_str, "-")[[1]]
next_first_number <- as.numeric(next_parts[1])
next_last_number <- as.numeric(next_parts[2])
bin <- (next_last_number - next_first_number) / 2
len_mid <- single_number + bin
} else {
prev_parts <- strsplit(prev_range_str, "-")[[1]]
prev_first_number <- as.numeric(prev_parts[1])
prev_last_number <- as.numeric(prev_parts[2])
bin <- (prev_last_number - prev_first_number) / 2
len_mid <- single_number - bin
}
} else {
parts <- strsplit(range_str, "-")[[1]]
first_number <- as.numeric(parts[1])
last_number <- as.numeric(parts[2])
len_mid <- last_number - bin
}
return(round(len_mid))
}
len_mid <- sapply(seq_along(data.CatL[,1]), function(i) {
prev_range_str <- if (i > 1) data.CatL[,1][i - 1] else ""
next_range_str <- if (i < length(data.CatL[,1])) data.CatL[,1][i + 1] else ""
range_to_median(data.CatL[,1][i], isFirst = i == 1, isLast = i == length(data.CatL[,1]), prev_range_str = prev_range_str, next_range_str = next_range_str)
})
}
else {
if (is.null(len_mid)) {
contains_special_char <- function(s) {
return(grepl("<|>", s))
}
range_to_bin <- function(range_str) {
parts <- strsplit(range_str, "-")[[1]]
first_number <- as.numeric(parts[1])
last_number <- as.numeric(parts[2])
bin <- (last_number - first_number) / 2
return(bin)
}
bin <- range_to_bin(data.CatL[,1][2])
range_to_median <- function(range_str, isFirst = FALSE, isLast = FALSE, prev_range_str = "", next_range_str = "") {
if (contains_special_char(range_str)) {
parts <- strsplit(range_str, "-")[[1]]
single_number <- as.numeric(gsub("[^0-9]", "", parts[1]))
if (isFirst) {
next_parts <- strsplit(next_range_str, "-")[[1]]
next_first_number <- as.numeric(next_parts[1])
next_last_number <- as.numeric(next_parts[2])
bin <- (next_last_number - next_first_number) / 2
len_mid <- single_number + bin
} else {
prev_parts <- strsplit(prev_range_str, "-")[[1]]
prev_first_number <- as.numeric(prev_parts[1])
prev_last_number <- as.numeric(prev_parts[2])
bin <- (prev_last_number - prev_first_number) / 2
len_mid <- single_number - bin
}
} else {
parts <- strsplit(range_str, "-")[[1]]
first_number <- as.numeric(parts[1])
last_number <- as.numeric(parts[2])
len_mid <- last_number - bin
}
return(round(len_mid))
}
len_mid <- sapply(seq_along(data.CatL[,1]), function(i) {
prev_range_str <- if (i > 1) data.CatL[,1][i - 1] else ""
next_range_str <- if (i < length(data.CatL[,1])) data.CatL[,1][i + 1] else ""
range_to_median(data.CatL[,1][i], isFirst = i == 1, isLast = i == length(data.CatL[,1]), prev_range_str = prev_range_str, next_range_str = next_range_str)
})
}
len_mid <- len_mid
else {
log_q<-log(mat_func(sel_L50,sel_L95,len_mid))
if (is.null(len_border)) {
extract_last_number <- function(range_str) {
parts <- strsplit(range_str, "-")[[1]]
last_number <- as.numeric(parts[2])
return(last_number)
}
len_border <- sapply(data.CatL[-nrow(data.CatL),1], extract_last_number)
} else {
len_border <- len_border
}
acl_cpp_path <- system.file("extdata", "ACL0.cpp", package = "ALSCL")
if (acl_cpp_path == "") {
stop("ACL.cpp not found in the package directory.")
}
# 编译ACL.cpp
compile(file = acl_cpp_path, "&> /tmp/logfile.log")
logN_at_len <- as.matrix(log(data.CatL[, 2:ncol(data.CatL)]+1e-5 ))
tmb.data=list(
logN_at_len = logN_at_len,
na_matrix=na_matrix,
log_q = log_q,
len_border =len_border,
age = ages,
Y = nyear,
A = nage,
L = nlen,
weight = as.matrix(weight),
mat=as.matrix(mat),
M=M
)
View(tmb.data)
logN_at_len<-as.matrix(log(cl[,2:22]+1e-5))
na_matrix<-matrix(1,nrow=9,ncol=21)
na_matrix[which(cl[,2:22]==0)]=0
age=c(1:5)
Y=21
A=5
L=9
weight=wgt[,2:22]
mat=mat[,2:22]
M=0.3
mat<-read.table("mat-5mm-all.csv",header=T,sep=",")
mat=mat[,2:22]
# prepare data
tmb.data1<-list(
logN_at_len=logN_at_len,
na_matrix=na_matrix,
log_q=log_q,
len_border=len_border,
age=age,
Y=Y,
A=A,
L=L,
weight=as.matrix(weight),
mat=as.matrix(mat),
M=M
)
View(tmb.data1)
View(tmb.data)
#
custom_bounds_and_params <- create_parameters(parameters, parameters.L, parameters.U)
View(custom_bounds_and_params)
View(parameters)
View(parameters.L)
parameters <- custom_bounds_and_params$parameters
# random effects
parameters$ dev_log_R = rep(0,nyear)
parameters$ dev_log_F = array(0,c(nage,nyear))
parameters$ dev_log_N0 = rep(0,(nage-1))
View(parameters)
parameters.L <- custom_bounds_and_params$parameters.L
parameters.U <- custom_bounds_and_params$parameters.U
lower=unlist(parameters.L)
upper=unlist(parameters.U)
map <- generate_map(map)
rnames=c("dev_log_R","dev_log_F","dev_log_N0")
#
acl_cpp_dir <- dirname(acl_cpp_path)
#
acl_dll_path <- file.path(acl_cpp_dir, "ACL0.dll")
#
dyn.load(acl_dll_path)
#dyn.load("ACL")
obj<-MakeADFun(tmb.data,parameters,niyrandom=rnames,map=map,DLL="ACL0",inner.control=list(trace=F, maxit=500))
View(obj)
nyear
nage
parameters1 = list(
log_init_Z = 0.5,
log_std_log_N0 = log(1),
mean_log_R = 5,
log_std_log_R = log(1),
logit_log_R = log(0.01/0.99),
mean_log_F = log(0.3),
log_std_log_F = log(1),
logit_log_F_y = log(0.75/0.25),
logit_log_F_a = log(0.75/0.25),
log_vbk = log(0.3),
log_Linf = log(90),
log_t0 = log(1/60),
log_cv_len = log(0.3),
log_std_index = log(0.1),
# random effects
dev_log_R = rep(0,Y),
dev_log_F = array(0,c(A,Y)),
dev_log_N0 = rep(0,(A-1))
)
parameters.L1 = list(
# fixed effects
log_init_Z = log(0.01),
log_std_log_N0 = -Inf,
mean_log_R = log(10),
log_std_log_R = log(0.01),
logit_log_R = -30,
mean_log_F = log(0.01),
#log_std_log_F = log(0.01),
logit_log_F_y = -10,
logit_log_F_a = -10,
log_vbk = log(0.1),
#log_Linf = log(50),
#log_t0 = -20,
log_cv_len = log(0.01),
log_std_index = log(0.01)
)
parameters.U1 = list(
# fixed effects
log_init_Z = log(10),
log_std_log_N0 = log(10),
mean_log_R = 20,
log_std_log_R = log(10),
logit_log_R = 20,
mean_log_F = log(2),
#log_std_log_F = log(10),
logit_log_F_y = 20,
logit_log_F_a = 10,
log_vbk = log(1),
#log_Linf = log(100),
#log_t0 = 0,
log_cv_len = log(1),
log_std_index = log(1)
)
lower1=unlist(parameters.L)
upper1=unlist(parameters.U)
map1 = list(
#log_std_log_N0 = factor(NA),
#log_std_log_R = factor(NA),
log_std_log_F = factor(NA),
log_Linf=factor(NA),
log_t0=factor(NA)
#log_std_index=factor(NA)
)
obj1<-MakeADFun(tmb.data1,parameters1,random=rnames,map=map1,DLL="ACL_krill",inner.control=list(trace=F, maxit=500))
compile("ACL_krill.cpp")
dyn.load("ACL_krill")
obj1<-MakeADFun(tmb.data1,parameters1,random=rnames,map=map1,DLL="ACL_krill",inner.control=list(trace=F, maxit=500))
View(obj1)
View(obj)
View(obj1)
parameters <- custom_bounds_and_params$parameters
parameters.L <- custom_bounds_and_params$parameters.L
parameters.U <- custom_bounds_and_params$parameters.U
lower=unlist(parameters.L)
upper=unlist(parameters.U)
map <- generate_map(map)
rnames=c("dev_log_R","dev_log_F","dev_log_N0")
#
acl_cpp_dir <- dirname(acl_cpp_path)
#
acl_dll_path <- file.path(acl_cpp_dir, "ACL0.dll")
#
dyn.load(acl_dll_path)
#dyn.load("ACL")
obj<-MakeADFun(tmb.data,parameters,niyrandom=rnames,map=map,DLL="ACL0",inner.control=list(trace=F, maxit=500))
View(obj)
View(obj1)
parameters
parameters$ dev_log_N0 = rep(0,(nage-1))
parameters
# random effects
parameters$ dev_log_R = rep(0,nyear)
parameters$ dev_log_F = array(0,c(nage,nyear))
parameters$ dev_log_N0 = rep(0,(nage-1))
parameters.L <- custom_bounds_and_params$parameters.L
parameters.U <- custom_bounds_and_params$parameters.U
lower=unlist(parameters.L)
upper=unlist(parameters.U)
map <- generate_map(map)
rnames=c("dev_log_R","dev_log_F","dev_log_N0")
#
acl_cpp_dir <- dirname(acl_cpp_path)
#
acl_dll_path <- file.path(acl_cpp_dir, "ACL0.dll")
#
dyn.load(acl_dll_path)
#dyn.load("ACL")
obj<-MakeADFun(tmb.data,parameters,niyrandom=rnames,map=map,DLL="ACL0",inner.control=list(trace=F, maxit=500))
cat("\nRunning optimization with nlminb...\n")
opt<-nlminb(obj$par,obj$fn,obj$gr,lower=lower,upper=upper,control=list(trace=0,iter.max=2000,eval.max=10000))
obj1<-MakeADFun(tmb.data1,parameters1,random=rnames,map=map1,DLL="ACL_krill",inner.control=list(trace=F, maxit=500))
opt<-nlminb(obj$par,obj$fn,obj$gr,lower=lower,upper=upper,control=list(trace=0,iter.max=2000,eval.max=10000))
opt<-nlminb(obj1$par,obj1$fn,obj1$gr,lower=lower1,upper=upper1,control=list(trace=0,iter.max=2000,eval.max=10000))
View(tmb.data1)
View(tmb.data)
View(map1)
View(map)
View(tmb.data)
View(parameters)
View(parameters1)
View(parameters.L)
View(parameters.L1)
View(parameters.U)
View(parameters.U1)
View(obj)
View(obj1)
#dyn.load("ACL")
obj<-MakeADFun(tmb.data,parameters,random=rnames,map=map,DLL="ACL0",inner.control=list(trace=F, maxit=500))
cat("\nRunning optimization with nlminb...\n")
opt<-nlminb(obj$par,obj$fn,obj$gr,lower=lower,upper=upper,control=list(trace=0,iter.max=2000,eval.max=10000))
?niyrandom
# opt1<-nlminb(opt$par,obj$fn,obj$gr,lower=lower,upper=upper,control=list(trace=0,iter.max=2000,eval.max=10000))
obj$gr(opt$par)
cbind(opt$par,lower,upper)
dyn.unload(acl_dll_path)
library(ALSCL)
load("E:/Oceanic Fisheries Ecosystem Laboratory/krill/ACL_krill.R.RData")
a=run_acl(data.Cat=cl,data.wgt=wgt,data.mat=mat,rec.age = 1,nage= 5,M=0.3,sel_L50 = 40, sel_L95=45,parameters =parameters,parameters.L=parameters.L,parameters.U=parameters.U,map =map ,len_mid =len_mid ,len_border =len_border)
View(a)
a[["final_outer_mgc"]]
sum(a[["final_outer_mgc"]])
0.0003047295
0.0003047295
mean(a[["final_outer_mgc"]])
a[["final_outer_mgc"]][length(a[["final_outer_mgc"]])-2]
a[["par_low_up"]]
a[["bound_hit"]]
library(sjPlot)
tab_df(a)
tab_df(a[["par_low_up"]])
df <- a[["par_low_up"]]
kdf<-kable(df)
library(knitr)
kdf<-kable(df)
kdf
df1<-a[["final_outer_mgc"]]
kable(df1)
a[["bound_hit"]]
a[["converge"]]
library(ALSCL)
diagnose_model(a)
a[["converge"]]
save.image("E:/Oceanic Fisheries Ecosystem Laboratory/krill/ACL_krill.R.RData")
load("E:/Oceanic Fisheries Ecosystem Laboratory/krill/ACL_krill.R.RData")
model=a
model_result=a
if(!is.list(model_result))
if(!is.list(model_result)) stop("Model output should be a list.")
if("bound_hit" %in% names(model_result)) {
if(model_result[["bound_hit"]]) {
cat("\nWarning: The model result has hit the boundaries.\n")
} else {
cat("\nThe model result has not hit the boundaries.\n")
}
} else {
cat("\nWarning: 'bound_hit' not found in the model output.\n")
}
model_result[["bound_hit"]]
if(model_result[["bound_hit"]]==FALSE) {
cat("\nWarning: The model result has hit the boundaries.\n")
} else {
cat("\nThe model result has not hit the boundaries.\n")
}
} else {
if("bound_hit" %in% names(model_result)) {
if(model_result[["bound_hit"]]==FALSE) {
cat("\nWarning: The model result has hit the boundaries.\n")
} else {
cat("\nThe model result has not hit the boundaries.\n")
}
} else {
cat("\nWarning: 'bound_hit' not found in the model output.\n")
}
# Check if the model result has hit the boundaries
if("bound_hit" %in% names(model_result)) {
if(model_result[["bound_hit"]]==TRUE) {
cat("\nWarning: The model result has hit the boundaries.\n")
} else {
cat("\n The model result has not hit the boundaries.\n")
}
} else {
cat("\nWarning: 'bound_hit' not found in the model output.\n")
}
model_result[["converge"]]
convergence <- grepl("relative convergence", model_result[["converge"]])
# Check if the model has converged
# Check model convergence
if("converge" %in% names(model)) {
convergence <- grepl("relative convergence", model_result[["converge"]])
if(convergence==TRUE) {
cat("\nThe model has converged.\n")
} else {
cat("\nWarning: The model has not converged.\n")
}
} else {
cat("\nWarning: 'converge' not found in the model output.\n")
}
library(ALSCL)
diagnose_model(a)
library(ALSCL)
diagnose_model(a)
summary(a)
View(a)
a[["report"]][["pla"]]
# 假设你的矩阵名为 pla
# 转换为数据框
pla=a[["report"]][["pla"]]
df <- as.data.frame(pla)
# 添加行名和列名（如果需要）
rownames(df) <- paste0("Length", 1:nrow(df))
colnames(df) <- paste0("Age", 1:ncol(df))
View(df)
# 转换为长格式
dfm <- melt(df)
# 绘制热图
ggplot(dfm, aes(x=Var2, y=Var1, fill=value)) +
geom_tile() +
scale_fill_gradient(low = "white", high = "steelblue") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
labs(x = "Age Group", y = "Length Group", fill = "Probability")
View(dfm)
dfm
View(df)
df$Length <- paste("Length",1:ncol(df), sep="")
# 假设你的矩阵名为 pla
# 转换为数据框
pla=a[["report"]][["pla"]]
df <- as.data.frame(pla)
# 添加行名和列名（如果需要）
colnames(df) <- paste0("Age", 1:ncol(df))
df$Length <- paste("Length",1:nrow(df), sep="")
View(df)
# 转换为长格式
dfm <- melt(df, id.vars = "Length")
View(dfm)
# 绘制热图
ggplot(dfm, aes(x=variable, y=Length, fill=value)) +
geom_tile() +
scale_fill_gradient(low = "white", high = "steelblue") +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
labs(x = "Age Group", y = "Length Group", fill = "Probability")
library(ALSCL)
plot_pla(a)
plot_pla(a,high_col = "red")
library(ALSCL)
plot_pla(a)
View(a)
# 绘制 dev_log_F 和 dev_log_R 的直方图
df2 <- data.frame(dev_log_F = a[["report"]][["dev_log_F"]],dev_log_R =  a[["report"]][["dev_log_R"]])
# 绘制 dev_log_F 和 dev_log_R 的直方图
dev_log_F = a[["report"]][["dev_log_F"]]
dev_log_R =  a[["report"]][["dev_log_R"]]
ggplot(dev_log_F, aes(x = dev_log_F)) +
geom_histogram(binwidth = 0.1, fill = "skyblue", alpha = 0.8, color = "black") +
labs(x = "dev_log_F", y = "Frequency") +
theme_minimal()
dev_log_F<-as.data.frame(dev_log_F)
ggplot(dev_log_F, aes(x = dev_log_F)) +
geom_histogram(binwidth = 0.1, fill = "skyblue", alpha = 0.8, color = "black") +
labs(x = "dev_log_F", y = "Frequency") +
theme_minimal()
View(dev_log_F)
View(dev_log_F)
dev_log_F_melted <- melt(dev_log_F)
colnames(dev_log_F_melted) <- c("Row", "Column", "Value")
ggplot(dev_log_F_melted, aes(x = Column, y = Value, group = Row, color = factor(Row))) +
geom_line() +
labs(x = "Column", y = "Value", color = "Row") +
theme_minimal()
# 绘制 dev_log_F 和 dev_log_R 的直方图
dev_log_F = a[["report"]][["dev_log_F"]]
dev_log_F
dev_log_R
dev_log_R
df2 <- data.frame(Year = 1:21, Dev_log_R = dev_log_R)
ggplot(data = df2, aes(x = Year, y = Dev_log_R)) +
geom_line() +
labs(x = "Year", y = "Dev_log_R") +
theme_minimal()
df2 <- data.frame(Year = 1:21, Dev_log_R = exp(dev_log_R))
ggplot(data = df2, aes(x = Year, y = Dev_log_R)) +
geom_line() +
labs(x = "Year", y = "Dev_log_R") +
theme_minimal()
plot_recruitment(a)
# 假设 dev_log_F 已经存在
df <- as.data.frame(dev_log_F)
df$AgeGroup <- factor(1:5)  # 添加年龄组
melted_df <- melt(df, id.vars = "AgeGroup")  # 将宽格式转为长格式，方便ggplot使用
ggplot(data = melted_df, aes(x = variable, y = AgeGroup, fill = value)) +
geom_tile() +
scale_fill_gradient(low = "white", high = "red") +
labs(x = "Year", y = "Age Group", fill = "Dev_log_F") +
theme_minimal()
# 假设 dev_log_F 已经存在
df <- as.data.frame(exp(dev_log_F))
df$AgeGroup <- factor(1:5)  # 添加年龄组
melted_df <- melt(df, id.vars = "AgeGroup")  # 将宽格式转为长格式，方便ggplot使用
ggplot(data = melted_df, aes(x = variable, y = AgeGroup, fill = value)) +
geom_tile() +
scale_fill_gradient(low = "white", high = "red") +
labs(x = "Year", y = "Age Group", fill = "Dev_log_F") +
theme_minimal()
a[["report"]][["cv_len"]]
a[["report"]][["CNA"]]
a[["report"]][["dev_log_N0"]]
library(ALSCL)
